<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Kiro</title>

    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“Š</text></svg>"
    />

    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <h1>Kiro</h1>
    <p>&ldquo;A cute system monitor&rdquo;</p>

    <div id="system">
      <h2 id="host__name">
        System <span class="highlight">127.0.0.1:3000</span>
      </h2>

      <ol>
        <li><span id="os">Ubuntu 20.04.2 LTS</span></li>
        <li>Kernel <span id="kernel">5.4.0-80-generic</span></li>
        <li>Uptime <span id="uptime">just now</span></li>
        <li>CPU Usage <span id="cpu__usage">00.00</span>%</li>
        <li>Free Memory <span id="free__memory">000</span> MB</li>
        <li>Used Memory <span id="used__memory">000</span> MB</li>
        <li>Total Memory <span id="total__memory">000</span> MB</li>
      </ol>
    </div>
  </body>

  <script>
    const $ = (query) => document.querySelector(query);
    const toMB = (bytes) => Math.round(bytes / 1024 / 1024);
    const toTitleCase = (str) =>
      str.replace(/\b\w/g, (char) => char.toUpperCase());

    const toDuration = (ms) => {
      const units = [
        { label: "days", value: 24 * 60 * 60 * 1000 },
        { label: "hours", value: 60 * 60 * 1000 },
        { label: "minutes", value: 60 * 1000 },
        { label: "seconds", value: 1000 },
      ];

      return units.reduce((acc, { label, value }) => {
        acc[label] = Math.floor(ms / value);
        ms %= value;
        return acc;
      }, {});
    };

    const socket = new WebSocket("ws://0.0.0.0:3000/ws");
    const formatter = new Intl.DurationFormat("en", { style: "narrow" });

    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);

      $("#host__name").innerHTML =
        `${toTitleCase(data.host_name)} <span class="highlight">${data.local_ip}</span>`;

      $("#cpu__usage").innerText = data.cpu_usage.toFixed(2);
      $("#free__memory").innerText = toMB(data.free_memory);
      $("#used__memory").innerText = toMB(data.used_memory);
      $("#total__memory").innerText = toMB(data.total_memory);

      $("#uptime").innerText = formatter.format(toDuration(data.uptime * 1000));

      $("#os").innerHTML = data.os;
      $("#kernel").innerText = data.kernel;
    };
  </script>
</html>
